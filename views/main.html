{% extends 'layout.html' %} 

{% block content %}
  <form class="search-form" action="/search" method="get">
    <input
      type="text"
      id="bookName"
      name="bookName"
      placeholder="ë„ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
    />
    <button type="submit">ê²€ìƒ‰</button>
  </form>
  {% if results %} 
    <div class="header">ê²€ìƒ‰ ê²°ê³¼</div>
    {% for book, like in results %}
    <div class="book" data-id="{{book.id}}" data-count="{{book.count}}">
      <div class="title">{{book.title}}</div>
      <div class="details">
        <div class="thumbnail">
          <a href="{{book.details}}" target="_blank">
            <img src="{{book.thumbnail}}" alt="ë„ì„œ ì´ë¯¸ì§€" style="width: 150px;"/>
          </a>
        </div>
        <div class="contents">
          <div class="publisher"><span>ì¶œíŒì‚¬</span>{{book.publisher}}</div>
          <div class="authors"><span>ì €ì</span>{{book.authors}}</div>
          <div class="price"><span>ê°€ê²©</span>{{book.price}}</div>
          <div class="count"><span>ë‚¨ì€ ìˆ˜ëŸ‰</span>{{book.count}}</div>
        </div>
      </div>
      <div class="options">
        <div class="buy">ë°”ë¡œêµ¬ë§¤</div>
        <div class="cart">ì¥ë°”êµ¬ë‹ˆ</div>
        <div class="review">ë¦¬ë·°ë³´ê¸°</div>
        {% if like.id %}
          <div class="unlike">â¤ï¸ {{book.likes}}</div>
        {% else %}
          <div class="like">ğŸ¤ {{book.likes}}</div>
        {% endif %}
      </div>
    </div>
    {% endfor %} 
  {% endif %} 
{% endblock %} 

{% block script %}
  <script>
    // ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
    [...document.getElementsByClassName("cart")].forEach((tag) => {
      tag.addEventListener('click', (e) => {
        const ancestor = e.currentTarget.closest(".book");
        const bookCount = +ancestor.dataset.count;
        if (!bookCount) {
          alert('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
          location.reload();
        } else {
          const bookId = +ancestor.dataset.id;
          axios.post('/cart', { bookId })
            .then((result) => {
              console.log(result);
              location.href = `/cart/?status=${result.data}`
            })
            .catch((err) => {
              console.error(err);
            })
        }
      })
    });

    // êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
    [...document.getElementsByClassName("buy")].forEach((tag) => {
      tag.addEventListener('click', (e) => {
        const ancestor = e.target.closest(".book");
        const bookId = +ancestor.dataset.id;
        axios.get("/purchase", {
          params: {
            bookId,
          }
        })
          .then((result) => {
            location.href = `/purchase?bookId=${bookId}`
          })
          .catch((err) => {
            console.error(err);
          })
      })
    });

    // ì¢‹ì•„ìš” ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
    [...document.getElementsByClassName("like")].forEach((tag) => {
      tag.addEventListener('click', (e) => {
        const ancestor = e.currentTarget.closest(".book");
        const bookId = Number(ancestor.dataset.id);
        axios.post("/likes", {
          bookId,
        })
          .then((result) => {
            if (result.data === 'success') {
              alert('ì„±ê³µì ìœ¼ë¡œ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤.');
              location.reload();
            }
          })
          .catch((err) => {
            console.error(err);
          })
      })
    });

    // ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•˜ì˜€ì„ ë•Œ
    [...document.getElementsByClassName("unlike")].forEach((tag) => {
      tag.addEventListener('click', (e) => {
        const ancestor = e.currentTarget.closest(".book");
        const bookId = Number(ancestor.dataset.id);
        axios.post("/likes", {
          bookId,
        })
          .then((result) => {
            if (result.data === 'success') {
              alert('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•˜ì˜€ìŠµë‹ˆë‹¤.');
              location.reload();
            }
          })
          .catch((err) => {
            console.error(err);
          })
      })
    });

    // ë¦¬ë·°í•˜ê¸° ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
    [...document.getElementsByClassName("review")].forEach((tag) => {
      tag.addEventListener('click', (e) => {
        const ancestor = e.currentTarget.closest(".book");
        const bookId = Number(ancestor.dataset.id);
        axios.get("/reviews", {
          params: { bookId },
        })
          .then(() => {
            location.href = `/reviews?bookId=${bookId}`
          })
          .catch((err) => {
            console.error(err);
          })
      })
    });
  </script>
{% endblock %}
